# 工作流名称，可在 GitHub Action 面板中看到
name: Compile Rule to SRS

# 新增：显式赋予 GITHUB_TOKEN 仓库内容的读写/推送权限
permissions:
  contents: write

# 触发条件：仅当 rule.json 文件在 push/pull_request 时触发（限定 main 分支，可根据你的分支修改）
on:
  push:
    branches: [ main ]
    paths: [ 'geo/geosite/rule.json' ]  # 仅监控 rule.json 文件的变动
  pull_request:
    branches: [ main ]
    paths: [ 'geo/geosite/rule.json' ]

# 执行的任务
jobs:
  compile-and-commit:
    # 运行环境：使用最新版 Ubuntu（sing-box 对 Linux 支持最好）
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码到 Action 运行环境（必须步骤，否则无法访问仓库文件）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
           fetch-depth: 0  # 拉取完整的仓库历史（必须，否则推送可能失败）
           persist-credentials: true  # 开启凭证持久化（关键：让后续git命令能读取GITHUB_TOKEN）

      # 步骤2：安装 sing-box 工具（官方一键安装脚本，适配最新版本）
      - name: Install sing-box
        run: |
            curl -fsSL https://sing-box.app/install.sh | bash
            # 验证安装是否成功，打印版本（可选，便于排查问题）
            sing-box version

      # 步骤3：执行编译命令，生成 rule.srs 文件
      - name: Compile rule.json to rule.srs
        run: sing-box rule-set compile geo/geosite/rule.json  # 你指定的核心编译命令

      # 步骤4：配置 Git 身份（提交文件时需要，使用 GitHub 官方机器人身份）
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 步骤5：提交并推送生成的 rule.srs 文件到仓库
      - name: Commit and push rule.srs
        run: |
          git add rule.srs
          git commit -m "chore: auto compile rule.json to rule.srs [skip ci]" || echo "No changes to commit"
          # 简化推送命令：直接推送到origin仓库的当前分支（无需手动拼接GITHUB_TOKEN）
          git push origin HEAD:${{ github.ref }}
